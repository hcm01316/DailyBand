<?xml version="1.0" encoding="UTF-8"?>
<!-- SQL 맵퍼 파일은 xml이기 때문에 제일 먼저 xml 선언이 옵니다. -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bnd.dailyband.mybatis.mapper.AdminMapper">

  <!-- 회원 목록 -->
  <select id="getMemberList" resultType="map">
    select m.*, r.BAND_TEAM_NM as BAND_NM from MBR_INFO m
    left join RCRIT_BBS r
    on m.MBR_ID = r.MBR_ID
    where m.MBR_ID != 'admin'
    group by m.MBR_ID;
  </select>

  <!-- 회원 권한 변경 -->
  <update id="changeType">
    update MBR_INFO set MBR_TY = #{role} where MBR_ID = #{id}
  </update>

  <!-- 회원 상태 변경 -->
  <update id="changeStatus">
    update MBR_INFO set MBR_STTUS = #{newStatus} where MBR_ID = #{id}
  </update>

  <!-- 전체 회원 수 -->
  <select id="getTotalMbrCount">
    select count(*) from MBR_INFO;
  </select>

  <!-- 일일 가입자 수-->
  <select id="getTodayMbrCount">
    select count(*) from MBR_INFO
    where date_format(REG_DT, '%Y-%m-%d') = date_format(now(), '%Y-%m-%d');
  </select>

  <!-- 방문정보 추가 -->
  <insert id="insertVisit">
    insert into VISIT_INFO (VISIT_DT)
    VALUES (NOW())
  </insert>

  <!-- 전체 방문 수-->
  <select id="getVisitCount" resultType="int">
    select COUNT(*) from VISIT_INFO
  </select>

  <!-- 일일 방문 수-->
  <select id="getTodayVisitCount" resultType="int">
    SELECT COUNT(*) FROM VISIT_INFO WHERE DATE(VISIT_DT) = CURDATE()
  </select>

  <!-- 지역별 회원 선호 지역 -->
  <select id="getPreferAreaCnt" resultType="map">
    select bc.CTGRY_NM as name, count(m.MBR_PREFER_AREA) as count
    from BAND_CTGRY bc
           left join MBR_INFO m
                     on instr(m.MBR_PREFER_AREA, bc.CTGRY_ID)
    where bc.CTGRY_TY = 0
    group by bc.CTGRY_NM
    having count > 0
    order by bc.CTGRY_NM
  </select>

  <!-- 장르별 회원 선호 장르 -->
  <select id="getPreferGenreCnt" resultType="map">
    select bc.CTGRY_NM as name, count(m.MBR_PREFER_GENRE) as count
    from BAND_CTGRY bc
           left join MBR_INFO m
                     on instr(m.MBR_PREFER_GENRE, bc.CTGRY_ID)
    where bc.CTGRY_TY = 1
    group by bc.CTGRY_NM
    having count > 0
    order by bc.CTGRY_NM
  </select>

  <!-- 분야별 회원 활동 분야 -->
  <select id="getActRealmCnt" resultType="map">
    select bc.CTGRY_NM as name, count(m.MBR_ACT_REALM) as count
    from BAND_CTGRY bc
           left join MBR_INFO m
                     on instr(m.MBR_ACT_REALM, bc.CTGRY_ID)
    where bc.CTGRY_TY = 2
    group by bc.CTGRY_NM
    having count > 0
    order by bc.CTGRY_NM
  </select>

  <!--게시판별 게시글 수 -->
  <select id="getBbsCnt" resultType="map">
    select bc.BBS_TY_NM as bbsNm, count(*) as cnt
    from RCRIT_BBS rb
           inner join BBS_CTGRY bc
                      on rb.BBS_TY_ID = bc.BBS_TY_ID
    group by bc.BBS_TY_NM;

  </select>

  <!-- 일별 가입자 수 -->
  <select id="getDayRegCnt" resultType="map">
    select DATE(REG_DT) as date, count(*) as cnt from MBR_INFO
    group by DATE(REG_DT)
    order by date;
  </select>

  <!-- 일별 방문 수-->
  <select id="getDayVisitCnt" resultType="map">
    select DATE(VISIT_DT) as date, count(*) as cnt from VISIT_INFO
    group by DATE(VISIT_DT)
    order by date;
  </select>

  <!-- 밴드원 모집 조회-->
  <select id="getRboardList" resultType="map">
    select rb.*,
           COALESCE(prpt.PRPT_STTUS, 0) as PRPT_STTUS,
           COALESCE(joined.JOIN_STTUS, 0) as JOIN_STTUS
    FROM RCRIT_BBS rb
           left outer join (
      select bpi.BBS_SN, COUNT(bpi.BBS_SN) as PRPT_STTUS
      from BAND_PRPT_INFO bpi
      where bpi.MBR_PRPT_STTUS in (1, 2)
      group by bpi.BBS_SN
    ) prpt on rb.BBS_SN = prpt.BBS_SN
           left outer join (
      select bpi.BBS_SN, COUNT(bpi.BBS_SN) as JOIN_STTUS
      from BAND_PRPT_INFO bpi
      where bpi.MBR_PRPT_STTUS = 0
      group by bpi.BBS_SN
    ) joined on rb.BBS_SN = joined.BBS_SN;
  </select>
</mapper>