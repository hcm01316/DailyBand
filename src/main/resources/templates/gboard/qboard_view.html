<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org/"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Q&A ê²Œì‹œê¸€</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/mboard_view.css}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="page">
    <th:block th:replace="~{dailyband/navbar :: navbarFragment}"/>
    <th:block th:replace="~{dailyband/header :: headerFragment}"/>
    <div class="page-wrapper">
        <!-- Page header -->
        <div class="page-header d-print-none">
            <div class="container-xl">
                <div class="row g-2 align-items-center">
                    <div class="col">
                        <h2 class="page-title">
                            Q&A ê²Œì‹œíŒ
                        </h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <input type="hidden" th:value="${board.BBS_SN}" id="BBS_SN">
            <input type="hidden" id="MBR_ID" name="MBR_ID" th:value="${#authentication.principal.MBR_ID}" />
            <h2 th:text="${board.BBS_SJ}"></h2>
            <div class="header">
                <img th:src="${board.MBR_PROFL_PHOTO}" alt="í”„ë¡œí•„ ì‚¬ì§„">
                <div class="info">
                    <a th:href="@{'/member/info?id=' + ${board.MBR_ID}}" th:text="${board.MBR_NCNM}"></a>
                    <p><span th:text="${#dates.format(board.REG_DT, 'yyyy-MM-dd HH:mm')}"></span></p>
                </div>
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-eye">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                        <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                    </svg>
                    <span th:text="${board.BBS_READ_CNT}">0</span>
                </p>
            </div>
            <div class="content">
                <p th:utext="${board.BBS_CN}"></p>

                <div class="youtube-video" th:if="${board.BBS_CN.contains('youtube.com')}">
                    <iframe width="560" height="315" th:src="${board.BBS_CN}" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="footer">
                <div class="likes">
                    <button class="btn btn-like" onclick="likeBoard()">ğŸ‘ ì¶”ì²œ</button>
                    <span th:text="${board.BBS_REMD_CNT}"></span>

                    <button class="btn btn-dislike" onclick="dislikeBoard()">ğŸ‘ ë¹„ì¶”ì²œ</button>
                    <span th:text="${board.BBS_NREMD_CNT}"></span>
                </div>
            </div>
            <div class="actions" th:if="${#authentication.principal.MBR_ID eq board.MBR_ID}">
                <form th:action="@{'/gboard/qna/update/' + ${board.BBS_SN}}" method="get">
                <button class="btn btn-action">ìˆ˜ì •</button>
                </form>
                <form th:action="@{'/gboard/qna/delete/' + ${board.BBS_SN}}" method="post" onsubmit="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit" class="btn btn-action">ì‚­ì œ</button>
                </form>
            </div>

            <div class="comment-area">
                <div class="comment-head">
                    <h3 class="comment-count">
                        ëŒ“ê¸€ <sup id="count"></sup>
                    </h3>
                    <div class="comment-order">
                        <ul class="comment-order-list">
                        </ul>
                    </div>
                </div>
                <ul class="comment-list">
                </ul>
                <div class="comment-write">
                    <div class="comment-write-area">
                        <span class="comment-write-area-name" th:text="${#authentication.principal.MBR_NCNM}"></span>
                        <span class="comment-write-area-count">0/200</span>
                        <textarea placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”" rows="1"
                                  class="comment-write-area-text" maxLength="200"></textarea>

                    </div>
                    <div class="register-box">
                        <div class="button btn-cancel">ì·¨ì†Œ</div>
                        <div class="button btn-register">ë“±ë¡</div>
                    </div>
                </div>
            </div>
        </div>
        <th:block th:replace="~{dailyband/footer :: footerFragment}"/>
    </div>
</div>
</div>
<script th:src="@{/js/view.js}"></script>
<script>

    // YouTube Data API í‚¤
    var API_KEY = 'AIzaSyBroII_7tvlLRoTWLzxIWISVn640O8jaqM';

    // ê²Œì‹œê¸€ ë‚´ìš©ì—ì„œ YouTube ë™ì˜ìƒ ë§í¬ ì¶”ì¶œì„ ìœ„í•œ ì •ê·œ í‘œí˜„ì‹
    var html = document.querySelector('.youtube-video').innerHTML;
    var regex = /https:\/\/www\.youtube\.com\/watch\?v=([\w-]+)/g;

    // ì •ê·œ í‘œí˜„ì‹ì— ë§¤ì¹­ë˜ëŠ” ì²« ë²ˆì§¸ ë§í¬ì˜ ë™ì˜ìƒ ID ì¶”ì¶œ
    var match = regex.exec(html);
    var videoId = match[1];

    // YouTube Data APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì˜ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    fetch('https://www.googleapis.com/youtube/v3/videos?key=' + API_KEY + '&part=snippet&id=' + videoId)
        .then(response => response.json())
        .then(data => {
            // ë™ì˜ìƒì„ í‘œì‹œí•  iframeì˜ src ì†ì„± ì—…ë°ì´íŠ¸
            var iframe = document.querySelector('.youtube-video iframe');
            iframe.src = 'https://www.youtube.com/embed/' + videoId;

            // ë™ì˜ìƒì˜ ì œëª©ì„ ì¶”ê°€í•˜ì—¬ í‘œì‹œ
            var titleElement = document.createElement('h2');
            titleElement.textContent = title;
            document.querySelector('.youtube-video').appendChild(titleElement);
        })
        .catch(error => console.error('Error fetching video data:', error));


    function likeBoard() {
        var boardId = document.getElementById('BBS_SN').value;
        $.ajax({
            type: "POST",
            url: "../../../gboard/qna/like/" + boardId,
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                var likeCountElement = $(".btn-like").next("span");
                var newCount = parseInt(likeCountElement.text()) + 1;
                likeCountElement.text(newCount);

                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                $(".btn-like").text("ğŸ‘ ì·¨ì†Œ");
                $(".btn-like").attr("onclick", "unlikeBoard()");

                // ë¹„ì¶”ì²œ ë²„íŠ¼ ë¹„í™œì„±í™”
                $(".btn-dislike").prop("disabled", true);
            },
            error: function(xhr, status, error) {
                console.error("ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error);
            }
        });
    }


    function unlikeBoard() {
        var boardId = document.getElementById('BBS_SN').value;
        $.ajax({
            type: "POST",
            url: "../../../gboard/qna/unlike/" + boardId,
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                var likeCountElement = $(".btn-like").next("span");
                var newCount = parseInt(likeCountElement.text()) - 1;
                likeCountElement.text(newCount);

                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                $(".btn-like").text("ğŸ‘ ì¶”ì²œ");
                $(".btn-like").attr("onclick", "likeBoard()");

                // ë¹„ì¶”ì²œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                $(".btn-dislike").prop("disabled", false);
            },
            error: function(xhr, status, error) {
                console.error("ì¶”ì²œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error);
            }
        });
    }


    function dislikeBoard() {
        var boardId = document.getElementById('BBS_SN').value;
        $.ajax({
            type: "POST",
            url: "../../../gboard/qna/dislike/" + boardId,
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                var dislikeCountElement = $(".btn-dislike").next("span");
                var newCount = parseInt(dislikeCountElement.text()) + 1;
                dislikeCountElement.text(newCount);

                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                $(".btn-dislike").text("ğŸ‘ ì·¨ì†Œ");
                $(".btn-dislike").attr("onclick", "undislikeBoard()");

                // ì¶”ì²œ ë²„íŠ¼ ë¹„í™œì„±í™”
                $(".btn-like").prop("disabled", true);
            },
            error: function(xhr, status, error) {
                console.error("ë¹„ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error);
            }
        });
    }


    function undislikeBoard() {
        var boardId = document.getElementById('BBS_SN').value;
        $.ajax({
            type: "POST",
            url: "../../../gboard/qna/undislike/" + boardId,
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                var dislikeCountElement = $(".btn-dislike").next("span");
                var newCount = parseInt(dislikeCountElement.text()) - 1;
                dislikeCountElement.text(newCount);

                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                $(".btn-dislike").text("ğŸ‘ ë¹„ì¶”ì²œ");
                $(".btn-dislike").attr("onclick", "dislikeBoard()");

                // ì¶”ì²œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                $(".btn-like").prop("disabled", false);
            },
            error: function(xhr, status, error) {
                console.error("ë¹„ì¶”ì²œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error);
            }
        });
    }
</script>
</body>
</html>
